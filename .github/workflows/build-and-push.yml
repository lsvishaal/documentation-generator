name: Build and Push to Docker Hub

on:
  push:
    branches:
      - main
    paths:
      - 'Dockerfile.agent'
      - 'documentation_generator/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.version'
      - '.github/workflows/build-and-push.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.agent
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/documentation-generator:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/documentation-generator:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/documentation-generator:buildcache,mode=max

      - name: Read agent config and skills
        id: agent_config
        run: |
          # Read the agent config file
          echo "config=$(cat documentation_generator/agent_config.json)" >> $GITHUB_OUTPUT

          # Extract version
          VERSION=$(grep -o '"version"[^,]*' documentation_generator/agent_config.json | head -1 | cut -d'"' -f4)
          echo "version=${VERSION:-1.0.0}" >> $GITHUB_OUTPUT

          # SIMPLE FIX: Hardcode the skills based on your skill.yaml
          # This avoids YAML parsing issues
          echo 'skills=[{"name": "readme-generator", "description": "Generates comprehensive, professional README files for open source projects by analyzing GitHub repositories", "version": "1.0.0", "tags": ["documentation", "readme", "github", "automation", "open-source"]}]' >> $GITHUB_OUTPUT

      - name: Log to backend service
        run: |
          # First, let's debug what we're sending
          CONFIG='${{ steps.agent_config.outputs.config }}'
          SKILLS='${{ steps.agent_config.outputs.skills }}'

          # Create JSON data with proper escaping
          JSON_DATA=$(cat << EOF
          {
            "agent": {
              "name": "documentation-generator",
              "author": "vishaallsv@gmail.com",
              "description": "The README Generator Agent is an intelligent automation tool that creates comprehensive, professional README files for open source projects",
              "version": "${{ steps.agent_config.outputs.version }}",
              "agent_trust": "low",
              "type": "documentation"
            },
            "skills": ${{ steps.agent_config.outputs.skills }},
            "framework": {
              "name": "agno",
              "version": "1.0.0"
            },
            "environment_variables": [
              {
                "key": "OPENROUTER_API_KEY",
                "description": "OpenRouter API key for LLM calls",
                "required": false
              },
              {
                "key": "GITHUB_ACCESS_TOKEN",
                "description": "GitHub access token used to fetch repository details",
                "required": true
              },
              {
                "key": "OUTPUT_DIR",
                "description": "Directory where generated README files are written",
                "required": false
              }
            ],
            "execution_cost": {},
            "auth": {},
            "deployment": {
              "url": "http://0.0.0.0:3773",
              "protocol_version": "1.0.0",
              "docker_image": "${{ secrets.DOCKERHUB_USERNAME }}/documentation-generator:latest",
              "docker_digest": "${{ steps.docker_build.outputs.digest }}",
              "platforms": ["linux/amd64", "linux/arm64"]
            },
            "repository": {
              "url": "https://github.com/${{ github.repository }}",
              "commit_sha": "${{ github.sha }}",
              "build_number": "${{ github.run_number }}"
            },
            "metadata": {
              "documentation_url": "https://github.com/Bindu-Agents-Vishaal/documentation-generator-agent",
              "domain": "documentation",
              "specialization": "readme-generation",
              "last_updated": "${{ github.event.head_commit.timestamp }}"
            }
          }
          EOF
          )

          echo "Sending JSON to Bindu..."
          echo "$JSON_DATA"

          # Send the request
          curl --location 'https://bindus.getbindu.com/bindu-register' \
            --header 'accept: application/json' \
            --header 'X-Bindu-CI: true' \
            --header 'X-API-Token: ${{ secrets.BINDU_API_TOKEN }}' \
            --header 'Content-Type: application/json' \
            --data "$JSON_DATA"
